import{formatDecimal as e,generateUUID as t}from"@heimdallr-sdk/utils";var n,r=((n=r||{}).NAME="@heimdallr-sdk",n),i=(e=>(e[e.FATAL=1]="FATAL",e[e.ERROR=2]="ERROR",e[e.WARN=3]="WARN",e[e.INFO=4]="INFO",e[e.DEBUG=5]="DEBUG",e))(i||{}),s=(e=>(e.SESSION_ID="HEIMDALLR_SDK_SESSION_ID",e.USER_ID="HEIMDALLR_SDK_USER_ID",e.APP="HEIMDALLR_SDK_APP_ID",e))(s||{}),a=(e=>(e.GET="GET",e.POST="POST",e.PUT="PUT",e.DELETE="DELETE",e))(a||{}),o=(e=>(e[e.LIFECYCLE=1]="LIFECYCLE",e[e.ERROR=2]="ERROR",e[e.PERFORMANCE=3]="PERFORMANCE",e[e.API=4]="API",e[e.DOM=5]="DOM",e[e.ROUTE=6]="ROUTE",e[e.CONSOLE=7]="CONSOLE",e[e.RECORD=8]="RECORD",e[e.VUE=9]="VUE",e[e.CUSTOMER=10]="CUSTOMER",e[e.EXTEND=11]="EXTEND",e))(o||{}),c=(e=>(e[e.CODEERROR=21]="CODEERROR",e[e.RESOURCEERROR=22]="RESOURCEERROR",e[e.UNHANDLEDREJECTION=23]="UNHANDLEDREJECTION",e[e.PAGECRASH=24]="PAGECRASH",e))(c||{}),u=(e=>(e[e.BEACON=1]="BEACON",e[e.IMG=2]="IMG",e[e.GET=3]="GET",e[e.POST=4]="POST",e))(u||{}),l=(e=>(e[e.CLICK=51]="CLICK",e))(l||{}),E=(e=>(e.LOG="log",e.INFO="info",e.WARN="warn",e.ERROR="error",e.ASSERT="assert",e))(E||{}),f=(e=>(e[e.XHR=41]="XHR",e[e.FETCH=42]="FETCH",e))(f||{}),d=(e=>(e[e.FMP=31]="FMP",e[e.FPS=32]="FPS",e[e.BASIC=33]="BASIC",e[e.VITALS=34]="VITALS",e[e.RESOURCE=35]="RESOURCE",e))(d||{}),m=(e=>(e[e.HASH=61]="HASH",e[e.HISTORY=62]="HISTORY",e))(m||{}),h=(e=>(e[e.CUSTOMER=111]="CUSTOMER",e))(h||{}),p=(e=>(e.LOCAL="local",e.SESSION="session",e.COOKIE="cookie",e.GLOBAL="global",e))(p||{}),R=(e=>(e[e.LOAD=11]="LOAD",e[e.UNLOAD=12]="UNLOAD",e))(R||{}),C=(e=>(e[e.MOBILE=1]="MOBILE",e[e.PC=2]="PC",e))(C||{}),S=(e=>(e[e.BROWSER=1]="BROWSER",e[e.WECHAT=2]="WECHAT",e[e.NODE=3]="NODE",e))(S||{}),O=(e=>(e[e.ROUTE=11]="ROUTE",e[e.CLICK=12]="CLICK",e[e.CONSOLE=13]="CONSOLE",e[e.XHR=14]="XHR",e[e.FETCH=15]="FETCH",e[e.UNHANDLEDREJECTION=16]="UNHANDLEDREJECTION",e[e.RESOURCE=17]="RESOURCE",e[e.CODE_ERROR=18]="CODE_ERROR",e[e.CUSTOMER=19]="CUSTOMER",e[e.FRAMEWORK=20]="FRAMEWORK",e[e.LIFECYCLE=21]="LIFECYCLE",e[e.CRASH=22]="CRASH",e))(O||{}),T=(e=>(e[e.API=21]="API",e[e.ROUTE=22]="ROUTE",e[e.CLICK=23]="CLICK",e[e.ERROR=24]="ERROR",e[e.LIFECYCLE=25]="LIFECYCLE",e[e.CUSTOMER=26]="CUSTOMER",e))(T||{}),v=(e=>(e.BASIC="basic",e.RESOURCE="resource",e.FMP="fmp",e.FPS="fps",e.VITALS="vitals",e))(v||{});var L,A,g,I,w=function(e,t){return{name:e,value:void 0===t?-1:t,delta:0,entries:[],id:"v2-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12)}},D=function(e,t){try{if(PerformanceObserver.supportedEntryTypes.includes(e)){if("first-input"===e&&!("PerformanceEventTiming"in self))return;var n=new PerformanceObserver((function(e){return e.getEntries().map(t)}));return n.observe({type:e,buffered:!0}),n}}catch(e){}},P=function(e,t){var n=function n(r){"pagehide"!==r.type&&"hidden"!==document.visibilityState||(e(r),t&&(removeEventListener("visibilitychange",n,!0),removeEventListener("pagehide",n,!0)))};addEventListener("visibilitychange",n,!0),addEventListener("pagehide",n,!0)},M=function(e){addEventListener("pageshow",(function(t){t.persisted&&e(t)}),!0)},F=function(e,t,n){var r;return function(i){t.value>=0&&(i||n)&&(t.delta=t.value-(r||0),(t.delta||void 0===r)&&(r=t.value,e(t)))}},y=-1,b=function(){return"hidden"===document.visibilityState?0:1/0},N=function(){P((function(e){var t=e.timeStamp;y=t}),!0)},H=function(){return y<0&&(y=b(),N(),M((function(){setTimeout((function(){y=b(),N()}),0)}))),{get firstHiddenTime(){return y}}},U=function(e,t){var n,r=H(),i=w("FCP"),s=function(e){"first-contentful-paint"===e.name&&(o&&o.disconnect(),e.startTime<r.firstHiddenTime&&(i.value=e.startTime,i.entries.push(e),n(!0)))},a=window.performance&&performance.getEntriesByName&&performance.getEntriesByName("first-contentful-paint")[0],o=a?null:D("paint",s);(a||o)&&(n=F(e,i,t),a&&s(a),M((function(r){i=w("FCP"),n=F(e,i,t),requestAnimationFrame((function(){requestAnimationFrame((function(){i.value=performance.now()-r.timeStamp,n(!0)}))}))})))},B=!1,k=-1,W=function(e,t){B||(U((function(e){k=e.value})),B=!0);var n,r=function(t){k>-1&&e(t)},i=w("CLS",0),s=0,a=[],o=function(e){if(!e.hadRecentInput){var t=a[0],r=a[a.length-1];s&&e.startTime-r.startTime<1e3&&e.startTime-t.startTime<5e3?(s+=e.value,a.push(e)):(s=e.value,a=[e]),s>i.value&&(i.value=s,i.entries=a,n())}},c=D("layout-shift",o);c&&(n=F(r,i,t),P((function(){c.takeRecords().map(o),n(!0)})),M((function(){s=0,k=-1,i=w("CLS",0),n=F(r,i,t)})))},_={passive:!0,capture:!0},G=new Date,K=function(e,t){L||(L=t,A=e,g=new Date,q(removeEventListener),V())},V=function(){if(A>=0&&A<g-G){var e={entryType:"first-input",name:L.type,target:L.target,cancelable:L.cancelable,startTime:L.timeStamp,processingStart:L.timeStamp+A};I.forEach((function(t){t(e)})),I=[]}},Y=function(e){if(e.cancelable){var t=(e.timeStamp>1e12?new Date:performance.now())-e.timeStamp;"pointerdown"==e.type?function(e,t){var n=function(){K(e,t),i()},r=function(){i()},i=function(){removeEventListener("pointerup",n,_),removeEventListener("pointercancel",r,_)};addEventListener("pointerup",n,_),addEventListener("pointercancel",r,_)}(t,e):K(t,e)}},q=function(e){["mousedown","keydown","touchstart","pointerdown"].forEach((function(t){return e(t,Y,_)}))},X=function(e,t){var n,r=H(),i=w("FID"),s=function(e){e.startTime<r.firstHiddenTime&&(i.value=e.processingStart-e.startTime,i.entries.push(e),n(!0))},a=D("first-input",s);n=F(e,i,t),a&&P((function(){a.takeRecords().map(s),a.disconnect()}),!0),a&&M((function(){var r;i=w("FID"),n=F(e,i,t),I=[],A=-1,L=null,q(addEventListener),r=s,I.push(r),V()}))},J={},j=function(e,t){var n,r=H(),i=w("LCP"),s=function(e){var t=e.startTime;t<r.firstHiddenTime&&(i.value=t,i.entries.push(e),n())},a=D("largest-contentful-paint",s);if(a){n=F(e,i,t);var o=function(){J[i.id]||(a.takeRecords().map(s),a.disconnect(),J[i.id]=!0,n(!0))};["keydown","click"].forEach((function(e){addEventListener(e,o,{once:!0,capture:!0})})),P(o,!0),M((function(r){i=w("LCP"),n=F(e,i,t),requestAnimationFrame((function(){requestAnimationFrame((function(){i.value=performance.now()-r.timeStamp,J[i.id]=!0,n(!0)}))}))}))}};class x{constructor(){this.lastFameTime=performance.now(),this.frame=0,this.fps=0,this.lastFameTime=performance.now()}run(){const e=performance.now(),t=e-this.lastFameTime;this.lastFameTime=e,this.fps=Math.round(1e3/t),this.frame++,e>1e3+this.lastTime&&(this.fps=Math.round(1e3*this.frame/(e-this.lastTime)),this.frame=0,this.lastTime=e),this.animationFramId=window.requestAnimationFrame((()=>{this.run()}))}get(){return e(this.fps,3)}destroy(){cancelAnimationFrame(this.animationFramId)}}const z=["SCRIPT","STYLE","META","HEAD","LINK"],$={SVG:2,IMG:2,CANVAS:4,OBJECT:4,EMBED:4,VIDEO:4};class Q{constructor(){const{responseEnd:e}=performance.timing;this.startTime=e,this.statusCollector=[],this.flag=!0,this.observer=null,this.callbackCount=1,this.resourceMap={},this.WW=window.innerWidth,this.WH=window.innerHeight}initObserver(){return new Promise((e=>{this.observer=new MutationObserver((()=>{const e=Date.now()-this.startTime,t=document.body;t&&this.doTag(t,this.callbackCount++),this.statusCollector.push({t:e})})),this.observer.observe(document,{childList:!0,subtree:!0}),"complete"===document.readyState?this.calFinallScore().then((t=>e(t))):window.addEventListener("load",(()=>{this.calFinallScore().then((t=>e(t)))}),!0)}))}getStyle(e,t){return window.getComputedStyle?window.getComputedStyle(e)[t]:e.currentStyle[t]}initResourceMap(){performance.getEntriesByType("resource").forEach((e=>{this.resourceMap[e.name]=e.responseEnd}))}doTag(e,t){const n=e.tagName;if(z.includes(n))return;if((e.children?e.children.length:0)>0)for(const n of Array.from(e.children))null===n.getAttribute("f_c")&&n.setAttribute("f_c",`${t}`),this.doTag(n,t)}calFinallScore(){return new Promise((t=>{if(MutationObserver&&this.flag)if(this.checkCanCal(this.startTime)){this.observer.disconnect(),this.flag=!1;const n=this.deepTraversal(document.body);if(!n)return void t(null);let r=null;n.dpss.forEach((e=>{r&&r.st?r.st<e.st&&(r=e):r=e})),this.initResourceMap();const i=this.filterTheResultSet(r.els),s=this.calResult(i);t(e(s,3))}else setTimeout((()=>{this.calFinallScore().then((e=>{t(e)}))}),500);else t(null)}))}calResult(e){let t=0;return e.forEach((e=>{let n=0;const{node:r,weight:i}=e,{tagName:s}=r;if(1===i){const e=+r.getAttribute("f_c")-1;n=this.statusCollector[e].t}else if(2===i)switch(s){case"IMG":n=this.resourceMap[r.src];break;case"SVG":{const e=+r.getAttribute("f_c")-1;n=this.statusCollector[e].t}break;default:{const e=this.getStyle(r,"background-image").match(/url\("(.*?)"\)/);let t="";e&&e[1]&&(t=e[1]),-1==t.indexOf("http")&&(t=location.protocol+e[1]),n=this.resourceMap[t]}}else if(4===i)switch(s){case"CANVAS":{const e=+r.getAttribute("f_c")-1;n=this.statusCollector[e].t}break;case"VIDEO":{const e=r;n=this.resourceMap[e.src],!n&&(n=this.resourceMap[e.poster])}}t<n&&(t=n)})),t}filterTheResultSet(e){let t=0;e.forEach((e=>{t+=e.st}));const n=t/e.length;return e.filter((({st:e})=>e>=n))}deepTraversal(e){if(!e)return null;const t=[];for(let n,r=0;n=e.children[r];r++){const e=this.deepTraversal(n);e.st&&t.push(e)}return this.calScore(e,t)}calScore(e,t){const{width:n,height:r,left:i,top:s}=e.getBoundingClientRect();let a=1;(this.WH<s||this.WW<i)&&(a=0);let o=0;t.forEach((e=>{o+=e.st}));let c=$[e.tagName]||1;1!==c||["initial","none"].includes(this.getStyle(e,"background-image"))||(c=$.IMG);let u=n*r*c*a,l=[{node:e,st:u,weight:c}];const E=this.calAreaPercent(e);return(o>u*E||0===E)&&(u=o,l=[],t.forEach((e=>{l=l.concat(e.els)}))),{dpss:t,st:u,els:l}}checkCanCal(e){const t=Date.now()-e;return t>1e3||t-(this.statusCollector&&this.statusCollector.length&&this.statusCollector[this.statusCollector.length-1].t||0)>1e3}calAreaPercent(e){const{left:t,right:n,top:r,bottom:i,width:s,height:a}=e.getBoundingClientRect(),o=this.WW,c=this.WH,u=n-t+(o-0)-(Math.max(n,o)-Math.min(t,0));if(u<=0)return 0;const l=i-r+(c-0)-(Math.max(i,c)-Math.min(r,0));return l<=0?0:u*l/(s*a)}}var Z=Object.defineProperty,ee=Object.getOwnPropertySymbols,te=Object.prototype.hasOwnProperty,ne=Object.prototype.propertyIsEnumerable,re=(e,t,n)=>t in e?Z(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,ie=(e,t)=>{for(var n in t||(t={}))te.call(t,n)&&re(e,n,t[n]);if(ee)for(var n of ee(t))ne.call(t,n)&&re(e,n,t[n]);return e};function se(n={}){const{performancOff:r=[]}=n;return{name:"perPlugin",monitor(t){const n=new x;if(!r.includes(v.FMP)){(new Q).initObserver().then((e=>{t({st:d.FMP,value:e})}))}r.includes(v.VITALS)||new Promise((t=>{Promise.all([new Promise((e=>{j((t=>{e(t.value)}))})),new Promise((e=>{X((t=>{e(t.value)}))})),new Promise((e=>{W((t=>{e(t.value)}))}))]).then((n=>{const[r,i,s]=n;t({lcp:e(r,3),fid:e(i,3),cls:e(s,3)})}))})).then((e=>{t(ie({st:d.VITALS},e))})),window.addEventListener("load",(()=>{r.includes(v.BASIC)||t(ie({st:d.BASIC},function(){const{domainLookupEnd:t,domainLookupStart:n,connectEnd:r,connectStart:i,secureConnectionStart:s,loadEventStart:a,domInteractive:o,domContentLoadedEventEnd:c,duration:u,responseStart:l,requestStart:E,responseEnd:f,fetchStart:d,transferSize:m,encodedBodySize:h,redirectEnd:p,redirectStart:R,redirectCount:C}=performance.getEntriesByType("navigation")[0],{startTime:S}=performance.getEntriesByType("paint").find((({name:e})=>"first-paint"===e))||{},{startTime:O}=performance.getEntriesByType("paint").find((({name:e})=>"first-contentful-paint"===e))||{};return{dnsSearch:e(t-n,3),tcpConnect:e(r-i,3),sslConnect:e(r-s,3),request:e(l-E,3),response:e(f-l,3),parseDomTree:e(o-f,3),resource:e(a-c,3),domReady:e(c-d,3),interactive:e(o-d,3),complete:e(a-d,3),httpHead:e(h-m,3),redirect:e(C,3),redirectTime:e(p-R,3),duration:e(u,3),fp:e(S,3),fcp:e(O,3)}}())),r.includes(v.RESOURCE)||t({st:d.RESOURCE,value:performance.getEntriesByType("resource").map((t=>({f:t.name,t:e(t.responseEnd,3)})))}),r.includes(v.FPS)||(n.run(),setTimeout((()=>{t({st:d.FPS,value:n.get()}),n.destroy()}),500))}),!0)},transform(e){return{lid:t(),t:this.getTime(),e:o.PERFORMANCE,dat:ie({},e)}}}}export{se as default};
