import{Core as e,Breadcrumb as t}from"@heimdallr-sdk/core";import{generateUUID as r,getStore as n,setStore as o,getDeepPropByDot as s,getCookie as i,beacon as a,imgRequest as E,obj2query as l,post as O,get as c,setCookie as R}from"@heimdallr-sdk/utils";var u,S=((u=S||{}).NAME="@heimdallr-sdk",u);const d="[@heimdallr-sdk]:";var f=(e=>(e[e.FATAL=1]="FATAL",e[e.ERROR=2]="ERROR",e[e.WARN=3]="WARN",e[e.INFO=4]="INFO",e[e.DEBUG=5]="DEBUG",e))(f||{}),C=(e=>(e.SESSION_ID="HEIMDALLR_SDK_SESSION_ID",e.USER_ID="HEIMDALLR_SDK_USER_ID",e.APP="HEIMDALLR_SDK_APP_ID",e))(C||{}),I=(e=>(e.GET="GET",e.POST="POST",e.PUT="PUT",e.DELETE="DELETE",e))(I||{}),h=(e=>(e[e.LIFECYCLE=1]="LIFECYCLE",e[e.ERROR=2]="ERROR",e[e.PERFORMANCE=3]="PERFORMANCE",e[e.API=4]="API",e[e.DOM=5]="DOM",e[e.ROUTE=6]="ROUTE",e[e.CONSOLE=7]="CONSOLE",e[e.RECORD=8]="RECORD",e[e.VUE=9]="VUE",e[e.CUSTOMER=10]="CUSTOMER",e[e.EXTEND=11]="EXTEND",e))(h||{}),m=(e=>(e[e.CODEERROR=21]="CODEERROR",e[e.RESOURCEERROR=22]="RESOURCEERROR",e[e.UNHANDLEDREJECTION=23]="UNHANDLEDREJECTION",e[e.PAGECRASH=24]="PAGECRASH",e))(m||{}),L=(e=>(e[e.BEACON=1]="BEACON",e[e.IMG=2]="IMG",e[e.GET=3]="GET",e[e.POST=4]="POST",e))(L||{}),D=(e=>(e[e.CLICK=51]="CLICK",e))(D||{}),A=(e=>(e.LOG="log",e.INFO="info",e.WARN="warn",e.ERROR="error",e.ASSERT="assert",e))(A||{}),N=(e=>(e[e.XHR=41]="XHR",e[e.FETCH=42]="FETCH",e))(N||{}),T=(e=>(e[e.FMP=31]="FMP",e[e.FPS=32]="FPS",e[e.BASIC=33]="BASIC",e[e.VITALS=34]="VITALS",e[e.RESOURCE=35]="RESOURCE",e))(T||{}),p=(e=>(e[e.HASH=61]="HASH",e[e.HISTORY=62]="HISTORY",e))(p||{}),b=(e=>(e[e.CUSTOMER=111]="CUSTOMER",e))(b||{}),g=(e=>(e.LOCAL="local",e.SESSION="session",e.COOKIE="cookie",e.GLOBAL="global",e))(g||{}),P=(e=>(e[e.LOAD=11]="LOAD",e[e.UNLOAD=12]="UNLOAD",e))(P||{}),U=(e=>(e[e.MOBILE=1]="MOBILE",e[e.PC=2]="PC",e))(U||{}),y=(e=>(e[e.BROWSER=1]="BROWSER",e[e.WECHAT=2]="WECHAT",e[e.NODE=3]="NODE",e))(y||{}),w=(e=>(e[e.ROUTE=11]="ROUTE",e[e.CLICK=12]="CLICK",e[e.CONSOLE=13]="CONSOLE",e[e.XHR=14]="XHR",e[e.FETCH=15]="FETCH",e[e.UNHANDLEDREJECTION=16]="UNHANDLEDREJECTION",e[e.RESOURCE=17]="RESOURCE",e[e.CODE_ERROR=18]="CODE_ERROR",e[e.CUSTOMER=19]="CUSTOMER",e[e.FRAMEWORK=20]="FRAMEWORK",e[e.LIFECYCLE=21]="LIFECYCLE",e[e.CRASH=22]="CRASH",e))(w||{}),v=(e=>(e[e.API=21]="API",e[e.ROUTE=22]="ROUTE",e[e.CLICK=23]="CLICK",e[e.ERROR=24]="ERROR",e[e.LIFECYCLE=25]="LIFECYCLE",e[e.CUSTOMER=26]="CUSTOMER",e))(v||{});const H=(e,t,r)=>{if(!t)return;const n=(e=>{let t=null;switch(e){case g.LOCAL:t=localStorage;break;case g.SESSION:t=sessionStorage}return t})(e);n&&n.setItem(t,JSON.stringify(r))},M=[];let F,_=!1;const B="undefined"!=typeof Promise?Promise.resolve():null,j=()=>{_=!1;const e=M.slice(0);M.length=0;for(const t of e)t()};if(B)F=()=>{B.then(j).catch((e=>console.error(e)))};else if("undefined"!=typeof MutationObserver&&"[object MutationObserverConstructor]"===MutationObserver.toString()){let e=1;const t=new MutationObserver(j),r=document.createTextNode(String(e));t.observe(r,{characterData:!0}),F=()=>{e=(e+1)%2,r.data=String(e)}}else F=()=>{setTimeout(j,0)};const G=/^\s*at (?:(.*?) ?\()?((?:file|https?|blob|chrome-extension|address|native|eval|webpack|<anonymous>|[-a-z]+:|.*bundle|\/).*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,k=e=>{const t=e.match(G);if(!t)return{};return{filename:t[2],functionName:t[1]||"",lineno:parseInt(t[3],10)||void 0,colno:parseInt(t[4],10)||void 0}};var K=Object.defineProperty,W=Object.getOwnPropertySymbols,x=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable,J=(e,t,r)=>t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,$=(e,t)=>{for(var r in t||(t={}))x.call(t,r)&&J(e,r,t[r]);if(W)for(var r of W(t))Y.call(t,r)&&J(e,r,t[r]);return e};const X="HEIMDALLR_SDK_ERROR_CACHE",V=e=>window.btoa(encodeURIComponent(JSON.stringify(e))),z=e=>{const{stkLimit:t=3}=e;return{name:"jsErrorPlugin",monitor(e){window.addEventListener("error",(t=>{t.preventDefault(),console.error(d,t),e({category:h.ERROR,data:t})}),!0)},transform(e){const{category:s,data:i}=e,{localName:a,src:E,href:l}=i.target||{},O=r();let c=n(g.SESSION,X);if(Array.isArray(c)||(c=[]),a){const e={source:a,href:E||l};this.breadcrumb.unshift({lid:O,bt:w.RESOURCE,l:f.FATAL,msg:`Unable to load "${e.href}"`,t:this.getTime()});const t=V(e);return c.includes(t)?null:(c.push(t),o(g.SESSION,X,c),{lid:O,t:this.getTime(),e:s,dat:$({st:m.RESOURCEERROR},e)})}const{message:R,error:u}=i;this.breadcrumb.unshift({lid:O,bt:w.CODE_ERROR,l:f.ERROR,msg:R,t:this.getTime()});const S=((e,t=3)=>{const{stack:r}=e;if(!r)return[];const n=[];for(const e of r.split("\n").slice(1)){const t=k(e);t&&n.push(t)}return n.slice(0,t)})(u,t),d=S.map((({lineno:e,colno:t,filename:r,functionName:n})=>({lin:e,col:t,file:r,fn:n}))),[C]=d,I=V($({msg:R},C));return c.includes(I)?null:(c.push(I),o(g.SESSION,X,c),{lid:O,t:this.getTime(),e:s,dat:{st:m.CODEERROR,msg:R,stk:d}})}}},q={name:"promiseErrorPlugin",monitor(e){window.addEventListener("unhandledrejection",(t=>{t.preventDefault(),console.error(d,t),e({category:h.ERROR,data:t})}))},transform(e){const{category:t,data:{reason:n}}=e;let o;"string"==typeof n?o=n:"object"==typeof n&&n.stack&&(o=n.stack);const s=r();return this.breadcrumb.unshift({lid:s,bt:w.UNHANDLEDREJECTION,l:f.ERROR,msg:o,t:this.getTime()}),{lid:s,t:this.getTime(),e:t,dat:{st:m.UNHANDLEDREJECTION,msg:o}}}};var Q=Object.defineProperty,Z=Object.getOwnPropertySymbols,ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable,re=(e,t,r)=>t in e?Q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,ne=(e,t)=>{for(var r in t||(t={}))ee.call(t,r)&&re(e,r,t[r]);if(Z)for(var r of Z(t))te.call(t,r)&&re(e,r,t[r]);return e};function oe(e){let t="";const{name:r,position:o}=e;return r&&o&&(t=function(e={}){const{name:t="",position:r=""}=e;switch(r){case g.LOCAL:case g.SESSION:return n(r,t);case g.COOKIE:return i(t);case g.GLOBAL:return s(t,window)}return""}(e),t||console.warn(d,`${r} does not exist on ${o}`)),{acc:t}}function se(e={}){const{userIdentify:t={}}=e;return{name:"lifeCyclePlugin",monitor(e){window.addEventListener("load",(()=>{this.sessionID=n(g.SESSION,C.SESSION_ID),this.sessionID||(this.sessionID=r(),o(g.SESSION,C.SESSION_ID,this.sessionID)),e(ne({lt:P.LOAD,href:location.href},oe.call(this,t)))})),window.addEventListener("unload",(()=>{e(ne({lt:P.UNLOAD,href:location.href},oe.call(this,t)))}))},transform(e){const t=r(),{lt:n}=e;let o=[];if(n===P.UNLOAD)o=[...this.breadcrumb.getStack()];return delete e.lt,{lid:t,t:this.getTime(),e:h.LIFECYCLE,b:o,dat:ne({st:n},e)}}}}var ie=Object.defineProperty,ae=Object.getOwnPropertySymbols,Ee=Object.prototype.hasOwnProperty,le=Object.prototype.propertyIsEnumerable,Oe=(e,t,r)=>t in e?ie(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,ce=(e,t)=>{for(var r in t||(t={}))Ee.call(t,r)&&Oe(e,r,t[r]);if(ae)for(var r of ae(t))le.call(t,r)&&Oe(e,r,t[r]);return e};class Re extends e{constructor(e){super(e),this.diff=0,this.breadcrumb=new t(e)}initAPP(){return e=this,t=null,r=function*(){const{initUrl:e,app:t}=this.getContext(),{headers:{date:r},data:{data:n}={}}=yield this.report(e,t,L.GET);this.setDiff(r);const{id:o=""}=n||{};return H(g.LOCAL,C.APP,o),o},new Promise(((n,o)=>{var s=e=>{try{a(r.next(e))}catch(e){o(e)}},i=e=>{try{a(r.throw(e))}catch(e){o(e)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(s,i);a((r=r.apply(e,t)).next())}));var e,t,r}isRightEnv(){return"undefined"!=typeof window}report(e,t,r=L.BEACON){if(r===L.BEACON&&navigator.sendBeacon)a(e,t);else if(r!==L.IMG&&navigator.sendBeacon){if(r!==L.POST)return c(e,t);{const r=l(t);O(e,r)}}else E(e,t)}transform(e){if(!e)return null;if(!this.sessionID&&(this.sessionID=n(g.SESSION,C.SESSION_ID),!this.sessionID))return null;let t=i(C.USER_ID);t||(t=r(),R(C.USER_ID,t,180));let o={};const{dat:{st:s}}=e,{href:a}=location;if(s===P.LOAD){const{userAgent:e,language:t}=navigator,{title:r,documentElement:n,body:s}=document,{innerWidth:i,innerHeight:a}=window;o={ttl:r,lan:t,ua:e,ws:`${i}x${a}`,ds:`${n.clientWidth||s.clientWidth}x${n.clientHeight||s.clientHeight}`}}return ce(ce({sid:this.sessionID,uid:t,p:y.BROWSER,url:a},o),e)}nextTick(e,t,...r){return function(e,t,...r){let n;if(M.push((()=>{if(e)try{e.call(t,...r)}catch(e){console.error(e)}else n&&n(r)})),_||(_=!0,F()),!e&&"undefined"!=typeof Promise)return new Promise((e=>{n=e}))}(e,t,...r)}setDiff(e){const t=new Date(e),r=Date.now()-t.getTime();(!this.diff||this.diff>r)&&(this.diff=r)}getTime(){return Date.now()-(this.diff||0)}}const ue=e=>{const t=new Re(e),{plugins:r=[]}=e;t.use([z.call(t,e),q,se.call(t,e),...r])};export{ue as default};
